<!-- <html>
<head>

<title></title>
<meta name="viewport" content="width=device-width, user-scalable=no">
<link rel="stylesheet"
	href="http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.css" />
<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script
	src="http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/main.css" />
<script type="text/javascript" src="js/databaseModule.js"></script>
<script type="text/javascript" src="js/date.format.js"></script>
<script type="text/javascript" src="js/userActionTracker.js"></script>
</head>

<body>
	
	<div class="app">
		<div data-role="page" id="user" data-theme="a">
			load user food list
	
			<script>
			function changeUserFoodInfoHTML(userFoodInfoHTML) {
				//Update the DIV called Content Area with the HTML string
				//$('#userFoodInfo').unbind();
			//	$('#userFoodInfo').empty();
				document.getElementById("userFoodInfo").innerHTML = userFoodInfoHTML;
				 
				//refresh divison
				$('#userFoodInfo').trigger("create");
			}
			
			function changeShoppingListHTML() {
				//$('#userShoppingList').unbind();
				$('#userShoppingList').empty();
				//Update the DIV called Content Area with the HTML string
				document.getElementById("userShoppingList").innerHTML = userShoppingListHTML;
				 
				
				//refresh divison
				$('#userShoppingList').trigger("create");
			}
			
				function getSliderAmount(rowNumber, nameOfSlider) {
					return userFoodUsageData[rowNumber][1] * $(nameOfSlider).val() / 100;
				}
				
				function sendUpdateAmount(id, d, value, purchaseId, rowNumber) {
					 $.ajax({
					        type       : "GET",
					        url        : sessionStorage.getItem("serverDomain") + "/updateFoodAmount?",
					        crossDomain: false,
					        beforeSend : function() {$.mobile.loading('show')},
					        complete   : function() {$.mobile.loading('hide')},
					        dataType   : 'json',
					        data       : {token : sessionStorage.getItem("usertoken"), foodId: id, date: d, quantity : value},
					        success    : function(data) {
					        	queryUpdateFoodAmount(purchaseId, value, rowNumber, data);
					        	undoStack.push( new Array(UNDO_UPDATE_USAGE_AMOUNT, purchaseId, rowNumber, data.foodID, data.date, userFoodUsageData[rowNumber][1]));
					        	console.log('Changes have been sent to the server successfully!');
					        },
					        error      : function(e) {
					        	console.log(e + ' : Changes could not be sent to the server!');
					            updateFoodAmountOffline(purchaseId, value, rowNumber);                
					        }
					    }); 
					 $('#undo').removeClass('ui-disabled');
					 return false;
				}
				
				function sendWaste(id, d, purchaseId, value, rowNumber) {
					 $.ajax({
					        type       : "GET",
					        url        : sessionStorage.getItem("serverDomain") + "/wasteFood?",
					        crossDomain: false,
					        beforeSend : function() {$.mobile.loading('show')},
					        complete   : function() {$.mobile.loading('hide')},
					        dataType   : 'json',
					        data       : {token : sessionStorage.getItem("usertoken"), foodId: id, quantity : value, date: d},
					        success    : function(data) {
					        	queryUpdateFoodWaste(data.members.wasteList, rowNumber, purchaseId);	
					        	console.log('Waste have been sent to the server successfully!');
					        },
					        error      : function(e) {
					        	console.log(e + ' : Waste changes could not be sent to the server!');
					            wasteFoodOffline(purchaseId, value, rowNumber,  new Date().format("mm/dd/yyyy hh:mm:ss"))  ;           
					        }
					    });    
					 return false;
				}
				
				function sendUsage(id, d, purchaseId, value, rowNumber) {
					 $.ajax({
					        type       : "GET",
					        url        : sessionStorage.getItem("serverDomain") + "/consumeFood?",
					        crossDomain: false,
					        beforeSend : function() {$.mobile.loading('show')},
					        complete   : function() {$.mobile.loading('hide')},
					        dataType   : 'json',
					        data       : {token : sessionStorage.getItem("usertoken"), foodId: id, quantity : value, date: d},
					        success    : function(data) {
					        	queryUpdateFoodUsage(data.members.usageList, rowNumber, purchaseId);
					        	
					        	console.log('Usage have been sent to the server successfully!');
					        },
					        error      : function(e) {
					            console.error(e + ' : Usage changes could not be sent to the server!');
					            consumeFoodOffline(purchaseId, value, rowNumber,  new Date().format("mm/dd/yyyy hh:mm:ss"))  ;          
					        }
					    });    
					 $('#undo').removeClass('ui-disabled');
					 return false;
				}
				
				function sendDeletion(fId, dateOfPurchase, purchaseId, rowNumber) {
					
					 $.ajax({
					        type       : "GET",
					        url        : sessionStorage.getItem("serverDomain") + "/deletePurchase?",
					        crossDomain: false,
					        beforeSend : function() {$.mobile.loading('show')},
					        complete   : function() {$.mobile.loading('hide')},
					        dataType   : 'json',
					        data       : {token : sessionStorage.getItem("usertoken"), foodId: fId, date: dateOfPurchase},
					        success    : function(data) {
					        	queryDeleteData(data.members.wasteList, rowNumber, purchaseId);	
					        	console.log('Deletion has been sent to the server successfully!');
					        	 toBeDeleted--; 
								 if(toBeDeleted == 0) {
									 loadUserList();
								 }
					        },
					        error      : function(e) {
					           console.error(e + 'Deletion could not be sent to the server!');					             
					           deletePurchaseDataOffline(purchaseId, rowNumber);
					           toBeDeleted--; 
								 if(toBeDeleted == 0) {
									 loadUserList();
								 }
					        }
					    });
					
					 return false;
				}
				
	
				function deleteUserFoodItem(id) {					
					var purchaseRow = findPurchaseInfoById(id);
					if(purchaseRow != -1) {
						sendDeletion(userFoodUsageData[purchaseRow][5], userFoodUsageData[purchaseRow][4], id, purchaseRow);
						
					}						 
				}
				
				 function buyItemFromShoppingList(id) {
					 var purchaseRow = findPurchaseInfoById(id);
					 $.ajax({
					        type       : "GET",
					        url        : sessionStorage.getItem("serverDomain") + "/buyFromShoppingList?",
					        crossDomain: false,
					        beforeSend : function() {$.mobile.loading('show')},
					        complete   : function() {$.mobile.loading('hide')},
					        dataType   : 'json',
					        data       : {token : sessionStorage.getItem("usertoken"), foodId: userFoodUsageData[purchaseRow][5], date: userFoodUsageData[purchaseRow][4]},
					        success    : function(data) {
					        	queryBuyFromShoppingList(data.members.purchase, purchaseRow, id);	
					        	console.log('Item from shopping to available list sent to the server!');
					        	loadUserList();
					        },
					        error      : function(e) {
					            console.error(e + 'Item could not be sent to the server!');					             
					            buyFromShoppingListOffline(purchaseRow, id);
					            loadUserList();
					        }
					    }); 
					 
					 return false;
					 
				 }
				 
				function undoChanges() {
					if(undoStack.length > 0) {
						var lastValue = undoStack.pop();	
						
						if(lastValue[0] == UNDO_UPDATE_USAGE_AMOUNT) {						
							 var purchaseRow = lastValue[2];
							 $.ajax({
							        type       : "GET",
							        url        : sessionStorage.getItem("serverDomain") + "/undoFoodAmount?",
							        crossDomain: false,
							        beforeSend : function() {$.mobile.loading('show')},
							        complete   : function() {$.mobile.loading('hide')},
							        dataType   : 'json',
							        data       : {
							        	token : sessionStorage.getItem("usertoken"), 
							        	foodId: userFoodUsageData[purchaseRow][5], 
							        	date: userFoodUsageData[purchaseRow][4],
							        	amount: lastValue[5]},
							        success    : function(data) {						        	 
							        	queryUpdateFoodAmount(lastValue[1], lastValue[5], lastValue[2], data);
							        	console.log('Changes have been sent to the server successfully!');
							        	loadUserList();
							        },
							        error      : function(e) {						        	
							        	undoStack.push(lastValue);
							        }
							    }); 
							 
						} else if (lastValue[0] == UNDO_ADD_CONSUMPTION) {						
							 var purchaseRow = lastValue[1];
							 $.ajax({
							        type       : "GET",
							        url        : sessionStorage.getItem("serverDomain") + "/deleteConsumption?",
							        crossDomain: false,
							        beforeSend : function() {$.mobile.loading('show')},
							        complete   : function() {$.mobile.loading('hide')},
							        dataType   : 'json',
							        data       : {
							        	token : sessionStorage.getItem("usertoken"), 
							        	foodId: userFoodUsageData[purchaseRow][5], 
							        	date: userFoodUsageData[purchaseRow][4],
							        	amount: lastValue[2], 
							        	consDate: lastValue[3]},
							        success    : function(data) {
							        	deleteConsumption(lastValue[1], lastValue[2], lastValue[3]);
							        },
							        error      : function(e) {
							        	undoStack.push(lastValue);
							        }
							    }); 
						} 
						if(undoStack.length == 0) {
							 $('#undo').addClass('ui-disabled');
						}
					}
					}
					
				
				function setSlidersToZero() {
					//set slider values to 0
					for (var i=0; i < userFoodUsageData.length; i++) {
						var nameValue = '#sliderUsage' + userFoodUsageData[i][0];
						$(nameValue).val(0);
						$(nameValue).trigger("change");
					}
				}
				/*  function setSwipeActionsForFoodUsage() {
					
						$('.row').bind( 'swiperight', function( e ) {
							var buttonValue =   e.currentTarget.id.replace("row","deleteItem");
							if(e.target.nodeName != 'SPAN') {
								$('#' + buttonValue).show();
							}
							
							 e.preventDefault();
							e.stopImmediatePropagation();
							return false;
							} );
						$('.row').bind( 'swipeleft', function( e ) {
							var buttonValue =   e.currentTarget.id.replace("row","deleteItem");
							if(e.target.nodeName != 'SPAN') {
								$('#' + buttonValue).hide();
							}
							e.stopImmediatePropagation();
							return false;
							} );
				 } */
				function setUserFoodTableActions(currentId) {
					$('#sliderUsage' + currentId).change(function(event, ui){
					    var slider_value = $(this).val();
						var amountVal =  event.target.id.replace("sliderUsage","amount");
						
						var oldVal =  findCurrentAmountById(event.target.id.replace("sliderUsage",""));
						var newVal = oldVal - oldVal * slider_value / 100;	
						if(newVal < 0) {
							newVal = 0;
						}
						
						 $('#' + amountVal).val(newVal.toFixed(2));
					});
					$( '#sliderUsage' + currentId ).on( 'slidestop', function( event ) { 
						var slider_value = $(this).val();
						var id = event.target.id.replace("sliderUsage","");
						var row = findPurchaseInfoById(id);
						sliderAmount = (userFoodUsageData[row][1] - userFoodUsageData[row][2] )* slider_value / 100;	
						if(sliderAmount > 0) {
							sendUsage(userFoodUsageData[row][5], userFoodUsageData[row][4], userFoodUsageData[row][0], sliderAmount, row);
						}			
					});
					$('#amount' + currentId).focusout(function() {
						var id = event.target.id.replace("amount","");
						var row = findPurchaseInfoById(id);
						sendUpdateAmount(userFoodUsageData[row][5], userFoodUsageData[row][4],  $(this).val(), userFoodUsageData[row][0], row);
					});
				}
				
				function highlightRow(currentId) {
					if(document.getElementById("row" + currentId).dataset.value == "unselected") {
						document.getElementById("row" + currentId).style.backgroundColor = '#6688BF';	
						document.getElementById("row" + currentId).style.opacity = '0.5';	
						document.getElementById("swipeImage" + currentId).border = "0";
						document.getElementById("row" + currentId).dataset.value = "selected";
						toBeDeleted++;
					} else {
						document.getElementById("row" + currentId).style.backgroundColor = '#2E2E2E';
						document.getElementById("row" + currentId).dataset.value = "unselected";
						document.getElementById("row" + currentId).style.opacity = '1';	
						document.getElementById("swipeImage" + currentId).border = "0";
						toBeDeleted--;
					}	
					if(toBeDeleted == 0) {
						 $('#deleteSelected').addClass('ui-disabled');
					} else {
						 $('#deleteSelected').removeClass('ui-disabled');
					}
					$('#row' + currentId).trigger('refresh');
					$('#swipeImage' + currentId).trigger('refresh');

				}
				
				function deleteSelectedItems() {
					 shTable = document.getElementById("shoppingListTable");
					 if(shTable != null) {
						 rows = shTable.getElementsByTagName('tr');
						 for(i=0; i < rows.length; i++) {
							 if(rows[i].dataset.value == "selected") {
								 idOfItem = rows[i].id.replace("row", "");							 
								 deleteUserFoodItem(idOfItem);
								 
							 }
						 }
					 }
					
					 avTable = document.getElementById("my-table");
					 if(avTable != null) {
						 rows = avTable.getElementsByTagName('tr');
						 for(i=0; i < rows.length; i++) {
							 if(rows[i].dataset.value == "selected") {
								 idOfItem = rows[i].id.replace("row", "");							 
								 deleteUserFoodItem(idOfItem);							 
							 }
						 }
					 }
					
				}			
				
				//global variable to store the coun of items for deletion
				var toBeDeleted = 0;
			
				loadUserList();

				/* 	if(newUsageNumber != 0) {
						$('#badge-page3').html(newUsageNumber).fadeIn();	
					} */
					if(newWasteNumber != 0) {
						$('#badge-page4').html(newWasteNumber).fadeIn();
					}
					
					
			</script>
			<div data-role="popup" id="popupDialog" data-overlay-theme="a">
                <i>Are you sure you want to delete old data? <br> All related information will be lost. </i>
                <div align="right">
					<input type="button" id="yes" value="Delete" data-inline="true" data-mini="true"
						data-theme="a" onclick="deleteOldData();">
			
					<input type="button" id="cancel" value="Cancel" data-inline="true" data-mini="true"
						data-theme="a" onclick="closePopup();">
				</div>
 			</div>
 			
 			<div data-role="popup" id="internetError" data-overlay-theme="a">
                <i>Internet connection is needed for this operation </i>
                <div align="right">
					<input type="button" id="ok" value="Ok" data-inline="true" data-mini="true" data-theme="a" >
				</div>
 			</div>
 			
			<div data-role="header" data-position="fixed" data-id="nav"> 
				<h1>EUPHORIA</h1>
			 <a href="#nav-panel" data-icon="bars" data-iconpos="notext"  data-iconshadow="false"  class="ui-icon-nodisc">Menu</a>
			
			</div>
			
			<div data-role="content">				
				
				<label class="table-title-label"><i><u>I will buy</u></i></label>
				<div id="userShoppingList"></div>
				<p></p>
				<label class="table-title-label"><i><u>I have</u></i></label>
				<select name="sortBy" id="sortBy"  class="select-class ui-icon-nodisc"
					 data-theme="a" value="Sort by Date" data-mini="true" data-inline="true" 
					 data-corners="false" data-iconshadow="false"  onchange="sortUserFoodsByDate(this.value);">
					<option value="ASC">Oldest</option>
					<option value="DESC">Newest</option>
				</select>
				
				
				<div id="userFoodInfo"></div>
				<p></p>
				 <div class="ui-grid-a">	
				<div class="ui-block-a">
					
					<a href="" type="button" id="deleteSelected" 
						data-iconshadow="false" data-mini="true" class="ui-icon-nodisc ui-disabled" 
						data-corners="false" data-icon="delete" data-iconpos="left" 
						data-theme="a" onclick="deleteSelectedItems();"  >Delete</a>
				</div>				
				<div class="ui-block-b">
					
					<a href="" type="button" id="undo" 
						data-iconshadow="false" data-mini="true" class="ui-icon-nodisc ui-disabled" 
						data-corners="false" data-icon="back" data-iconpos="left" 
						data-theme="a" onclick="undoChanges();"  >Undo</a>
				</div>
				</div>
			</div>
			<div data-role="footer" data-position="fixed">
			<div data-role="navbar">
				<ul>
					<li><a href="foodList.html"  id="foodList" data-icon="search" data-iconshadow="false" data-inline="true" data-transition="slide" class="ui-btn ui-icon-nodisc">Items</a></li>
					<li><a href="foodUsage.html" data-icon="home" data-iconshadow="false" data-inline="true" data-transition="slide" class="ui-btn ui-icon-nodisc">My List</a></li>
					<li><a href="usagereason.html" id="utensils" data-icon="custom" class="ui-badge-container">
					<span id="badge-page3" class="badge"></span></a></li>
					<li><a href="wastereason.html" data-icon="info" data-iconshadow="false" data-inline="true" data-transition="slide" class="ui-btn ui-icon-nodisc">
					<span id="badge-page4" class="badge"></span>My Bin</a></li>					
				
					<li><a href="survey.html" data-icon="edit" data-inline="true"></a></li>
					<li><a href="userInfo.html" id="userInfo" data-icon="custom" class="ui-badge-container"></a></li>
					</ul>
			</div>/navbar
			</div>
			<div data-role="panel" data-position-fixed="true" data-theme="a"
				id="nav-panel">
				<ul data-role="listview" data-theme="a" class="nav-search">
					<li data-icon="delete"><a href="#" data-rel="close">Close</a></li>
					<li data-icon="edit" ><a href="survey.html" id="survey" data-transition="slide">Survey</a></li>
					<li data-icon="gear" ><a href="userInfo.html" id="userInfo" data-transition="slide">Me</a></li>

				</ul>
			</div>
			/panel
		</div>
	</div>
<script type="text/javascript" src="cordova.js"></script>
</body>
</html>

 -->