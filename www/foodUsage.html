<html>
<head>

<title></title>

<link rel="stylesheet"
	href="http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.css" />
<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script
	src="http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/main.css" />
<script type="text/javascript" src="js/databaseModule.js"></script>
<script type="text/javascript" src="js/date.format.js"></script>
<script type="text/javascript" src="js/userActionTracker.js"></script>
</head>

<body>
	
	<div class="app">
		<div data-role="page" id="user" data-theme="a">
			<!-- load user food list -->
	
			<script>
			loadUserList();					
				if(newUsageNumber != 0) {
					$('#badge-page3').html(newUsageNumber).fadeIn();	
				}
				if(newWasteNumber != 0) {
					$('#badge-page4').html(newWasteNumber).fadeIn();
				}
		
				function getSliderAmount(rowNumber, nameOfSlider) {
					return userFoodUsageData[rowNumber][1] * $(nameOfSlider).val() / 100;
				}
				
				function sendUpdateAmount(id, d, value, purchaseId, rowNumber) {
					 $.ajax({
					        type       : "GET",
					        url        : sessionStorage.getItem("serverDomain") + "/updateFoodAmount?",
					        crossDomain: false,
					        beforeSend : function() {$.mobile.loading('show')},
					        complete   : function() {$.mobile.loading('hide')},
					        dataType   : 'json',
					        data       : {token : sessionStorage.getItem("usertoken"), foodId: id, date: d, quantity : value},
					        success    : function(data) {
					        	queryUpdateFoodAmount(purchaseId, value, rowNumber, data);
					        	undoStack.push( new Array(UNDO_UPDATE_USAGE_AMOUNT, purchaseId, rowNumber, data.foodID, data.date, userFoodUsageData[rowNumber][1]));
					        	console.log('Changes have been sent to the server successfully!');
					        },
					        error      : function(e) {
					        	console.log(e + ' : Changes could not be sent to the server!');
					            updateFoodAmountOffline(purchaseId, value, rowNumber);                
					        }
					    }); 
					 $('#undo').removeClass('ui-disabled');
					 return false;
				}
				
				function sendWaste(id, d, purchaseId, value, rowNumber) {
					 $.ajax({
					        type       : "GET",
					        url        : sessionStorage.getItem("serverDomain") + "/wasteFood?",
					        crossDomain: false,
					        beforeSend : function() {$.mobile.loading('show')},
					        complete   : function() {$.mobile.loading('hide')},
					        dataType   : 'json',
					        data       : {token : sessionStorage.getItem("usertoken"), foodId: id, quantity : value, date: d},
					        success    : function(data) {
					        	queryUpdateFoodWaste(data.members.wasteList, rowNumber, purchaseId);	
					        	console.log('Waste have been sent to the server successfully!');
					        },
					        error      : function(e) {
					        	console.log(e + ' : Waste changes could not be sent to the server!');
					            wasteFoodOffline(purchaseId, value, rowNumber,  new Date().format("mm/dd/yyyy hh:mm:ss"))  ;           
					        }
					    });    
					 return false;
				}
				
				function sendUsage(id, d, purchaseId, value, rowNumber) {
					 $.ajax({
					        type       : "GET",
					        url        : sessionStorage.getItem("serverDomain") + "/consumeFood?",
					        crossDomain: false,
					        beforeSend : function() {$.mobile.loading('show')},
					        complete   : function() {$.mobile.loading('hide')},
					        dataType   : 'json',
					        data       : {token : sessionStorage.getItem("usertoken"), foodId: id, quantity : value, date: d},
					        success    : function(data) {
					        	queryUpdateFoodUsage(data.members.usageList, rowNumber, purchaseId);
					        	
					        	console.log('Usage have been sent to the server successfully!');
					        },
					        error      : function(e) {
					            console.error(e + ' : Usage changes could not be sent to the server!');
					            consumeFoodOffline(purchaseId, value, rowNumber,  new Date().format("mm/dd/yyyy hh:mm:ss"))  ;          
					        }
					    });    
					 $('#undo').removeClass('ui-disabled');
					 return false;
				}
				
				function sendDeletion(fId, dateOfPurchase, purchaseId, rowNumber) {
					 $.ajax({
					        type       : "GET",
					        url        : sessionStorage.getItem("serverDomain") + "/deletePurchase?",
					        crossDomain: false,
					        beforeSend : function() {$.mobile.loading('show')},
					        complete   : function() {$.mobile.loading('hide')},
					        dataType   : 'json',
					        data       : {token : sessionStorage.getItem("usertoken"), foodId: fId, date: dateOfPurchase},
					        success    : function(data) {
					        	queryDeleteData(data.members.wasteList, rowNumber, purchaseId);	
					        	console.log('Deletion has been sent to the server successfully!');
					        },
					        error      : function(e) {
					            console.error(e + 'Deletion could not be sent to the server!');					             
					           deletePurchaseDataOffline(purchaseId, rowNumber);
					        }
					    });    
					 return false;
				}
				
				function confirmDeletion() {
					 $('#popupDialog' ).popup('open');
				}
				
				function closePopup() {
					 $('#popupDialog' ).popup('close');
				}
				
				function showError() {
					 $('#popupDialog' ).popup('close'); 
					 $('#internetError' ).popup('open');
				}
	
				function deleteUserFoodItem(id) {					
					var purchaseRow = findPurchaseInfoById(id);
					if(purchaseRow != -1) {
						sendDeletion(userFoodUsageData[purchaseRow][5], userFoodUsageData[purchaseRow][4], id, purchaseRow);
						
					}						 
				}
				
				 function buyItemFromShoppingList(id) {
					 var purchaseRow = findPurchaseInfoById(id);
					 $.ajax({
					        type       : "GET",
					        url        : sessionStorage.getItem("serverDomain") + "/buyFromShoppingList?",
					        crossDomain: false,
					        beforeSend : function() {$.mobile.loading('show')},
					        complete   : function() {$.mobile.loading('hide')},
					        dataType   : 'json',
					        data       : {token : sessionStorage.getItem("usertoken"), foodId: userFoodUsageData[purchaseRow][5], date: userFoodUsageData[purchaseRow][4]},
					        success    : function(data) {
					        	queryBuyFromShoppingList(data.members.purchase, purchaseRow, id);	
					        	console.log('Item from shopping to available list sent to the server!');
					        	loadUserList();
					        },
					        error      : function(e) {
					            console.error(e + 'Item could not be sent to the server!');					             
					            buyFromShoppingListOffline(purchaseRow, id);
					            loadUserList();
					        }
					    }); 
					 
					 return false;
					 
				 }
				 
				function undoChanges() {
					if(undoStack.length > 0) {
						var lastValue = undoStack.pop();	
						
						if(lastValue[0] == UNDO_UPDATE_USAGE_AMOUNT) {						
							 var purchaseRow = lastValue[2];
							 $.ajax({
							        type       : "GET",
							        url        : sessionStorage.getItem("serverDomain") + "/undoFoodAmount?",
							        crossDomain: false,
							        beforeSend : function() {$.mobile.loading('show')},
							        complete   : function() {$.mobile.loading('hide')},
							        dataType   : 'json',
							        data       : {
							        	token : sessionStorage.getItem("usertoken"), 
							        	foodId: userFoodUsageData[purchaseRow][5], 
							        	date: userFoodUsageData[purchaseRow][4],
							        	amount: lastValue[5]},
							        success    : function(data) {						        	 
							        	queryUpdateFoodAmount(lastValue[1], lastValue[5], lastValue[2], data);
							        	console.log('Changes have been sent to the server successfully!');
							        	loadUserList();
							        },
							        error      : function(e) {						        	
							        	undoStack.push(lastValue);
							        }
							    }); 
							 
						} else if (lastValue[0] == UNDO_ADD_CONSUMPTION) {						
							 var purchaseRow = lastValue[1];
							 $.ajax({
							        type       : "GET",
							        url        : sessionStorage.getItem("serverDomain") + "/deleteConsumption?",
							        crossDomain: false,
							        beforeSend : function() {$.mobile.loading('show')},
							        complete   : function() {$.mobile.loading('hide')},
							        dataType   : 'json',
							        data       : {
							        	token : sessionStorage.getItem("usertoken"), 
							        	foodId: userFoodUsageData[purchaseRow][5], 
							        	date: userFoodUsageData[purchaseRow][4],
							        	amount: lastValue[2], 
							        	consDate: lastValue[3]},
							        success    : function(data) {
							        	deleteConsumption(lastValue[1], lastValue[2], lastValue[3]);
							        },
							        error      : function(e) {
							        	undoStack.push(lastValue);
							        }
							    }); 
						} 
						if(undoStack.length == 0) {
							 $('#undo').addClass('ui-disabled');
						}
					}
					}
					
				
				function setSlidersToZero() {
					//set slider values to 0
					for (var i=0; i < userFoodUsageData.length; i++) {
						var nameValue = '#sliderUsage' + userFoodUsageData[i][0];
						$(nameValue).val(0);
						$(nameValue).trigger("change");
					}
				}
				 function setSwipeActionsForFoodUsage() {
						$('.row').bind( 'swiperight', function( e ) {
							var buttonValue =   e.currentTarget.id.replace("row","deleteItem");
							if(e.target.nodeName != 'SPAN') {
								$('#' + buttonValue).show();
							}
							
							 e.preventDefault();
							e.stopImmediatePropagation();
							return false;
							} );
						$('.row').bind( 'swipeleft', function( e ) {
							var buttonValue =   e.currentTarget.id.replace("row","deleteItem");
							if(e.target.nodeName != 'SPAN') {
								$('#' + buttonValue).hide();
							}
							e.stopImmediatePropagation();
							return false;
							} );
				 }
				function setUserFoodTableActions(currentId) {
					$('#sliderUsage' + currentId).change(function(event, ui){
					    var slider_value = $(this).val();
						var amountVal =  event.target.id.replace("sliderUsage","amount");
						
						var oldVal =  findCurrentAmountById(event.target.id.replace("sliderUsage",""));
						var newVal = oldVal - oldVal * slider_value / 100;	
						if(newVal < 0) {
							newVal = 0;
						}
						
						 $('#' + amountVal).val(newVal.toFixed(2));
					});
					$( '#sliderUsage' + currentId ).on( 'slidestop', function( event ) { 
						var slider_value = $(this).val();
						var id = event.target.id.replace("sliderUsage","");
						var row = findPurchaseInfoById(id);
						sliderAmount = (userFoodUsageData[row][1] - userFoodUsageData[row][2] )* slider_value / 100;	
						if(sliderAmount > 0) {
							sendUsage(userFoodUsageData[row][5], userFoodUsageData[row][4], userFoodUsageData[row][0], sliderAmount, row);
						}			
					});
					$('#amount' + currentId).focusout(function() {
						var id = event.target.id.replace("amount","");
						var row = findPurchaseInfoById(id);
						sendUpdateAmount(userFoodUsageData[row][5], userFoodUsageData[row][4],  $(this).val(), userFoodUsageData[row][0], row);
					});
					$('#deleteItem' + currentId).hide();
				}
				
				
			</script>
			<div data-role="popup" id="popupDialog" data-overlay-theme="a">
                <i>Are you sure you want to delete old data? <br> All related information will be lost. </i>
                <div align="right">
					<input type="button" id="yes" value="Delete" data-inline="true" data-mini="true"
						data-theme="a" onclick="deleteOldData();">
			
					<input type="button" id="cancel" value="Cancel" data-inline="true" data-mini="true"
						data-theme="a" onclick="closePopup();">
				</div>
 			</div>
 			
 			<div data-role="popup" id="internetError" data-overlay-theme="a">
                <i>Internet connection is needed for this operation </i>
                <div align="right">
					<input type="button" id="ok" value="Ok" data-inline="true" data-mini="true" data-theme="a" >
				</div>
 			</div>
 			
			<div data-role="header" data-position="fixed" data-id="nav"> 
				<h1>EUPHORIA</h1>
			 <a href="#nav-panel" data-icon="bars" data-iconpos="notext"  data-iconshadow="false"  class="ui-icon-nodisc">Menu</a>
			
			</div>
			
			<div data-role="content">				
				
				<label class="table-title-label"><i>I will buy</i></label>
				<div id="userShoppingList"></div>
				
				<select name="sortBy" id="sortBy"  class="select-class ui-icon-nodisc"
					 data-theme="a" value="Sort by Date" data-mini="true" data-inline="true" 
					 data-corners="false" data-iconshadow="false"  onchange="sortUserFoodsByDate(this.value);">
					<option value="ASC">Oldest</option>
					<option value="DESC">Newest</option>
				</select>
				<label class="table-title-label"><i>I have</i></label>
				
				<div id="userFoodInfo"></div>				
				<div align="right">
					
					<a href="" type="button" id="undo" data-inline="true" 
						data-iconshadow="false" data-mini="true" class="ui-icon-nodisc ui-disabled" 
						data-corners="false" data-icon="back" data-iconpos="left" 
						data-theme="a" onclick="undoChanges();"  >Undo</a>
				</div>
			</div>
			<div data-role="footer" data-position="fixed">
			<div data-role="navbar">
				<ul>
					<li><a href="foodList.html"  data-icon="search" data-iconshadow="false" data-inline="true" data-transition="slide" class="ui-btn ui-icon-nodisc"></a></li>
					<li><a href="foodUsage.html" data-icon="home" data-iconshadow="false" data-inline="true" data-transition="slide" class="ui-btn ui-icon-nodisc"></a></li>
					<!-- <li><a href="usagereason.html" id="utensils" data-icon="custom" class="ui-badge-container">
					<span id="badge-page3" class="badge"></span></a></li> -->
					<li><a href="wastereason.html" data-icon="info" data-iconshadow="false" data-inline="true" data-transition="slide" class="ui-btn ui-icon-nodisc">
					<span id="badge-page4" class="badge"></span></a></li>					
				
					<!-- <li><a href="survey.html" data-icon="edit" data-inline="true"></a></li>
					<li><a href="userInfo.html" id="userInfo" data-icon="custom" class="ui-badge-container"></a></li> -->
					</ul>
			</div><!-- /navbar -->
			</div>
			<div data-role="panel" data-position-fixed="true" data-theme="a"
				id="nav-panel">
				<ul data-role="listview" data-theme="a" class="nav-search">
					<li data-icon="delete"><a href="#" data-rel="close">Close
							menu</a></li>
					<li data-icon="edit" ><a href="survey.html" id="survey" >Survey</a></li>
					<li data-icon="gear" ><a href="userInfo.html" id="userInfo" >User Profile</a></li>

				</ul>
			</div>
			<!-- /panel -->
		</div>
	</div>
<script type="text/javascript" src="cordova.js"></script>
</body>
</html>

